<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>수면일지 막대그래프 달력</title>

  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/style.css" />
  <script src="/static/disable-copy.js"></script>
  <script src="/static/global-loader.js"></script>

  <style>
    /* ===== 수면일지 전용 스타일 ===== */

    .sleep-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 16px;
      margin-top: 12px;
      align-items: flex-end;
    }

    .sleep-controls .field-label {
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: #444;
    }

    .sleep-type-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 0.9rem;
    }

    .sleep-type-group label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      white-space: nowrap;
    }

    .sleep-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      font-size: 0.8rem;
      margin-top: 10px;
      color: #444;
    }

    .legend-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 16px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
    }

    .legend-night { background: rgba(37, 99, 235, 0.28); }
    .legend-awake { background: rgba(234, 179, 8, 0.45); }
    .legend-nap { background: rgba(52, 211, 153, 0.45); }

    .legend-pill-wrap {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-pill {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #dc2626;
      border: 1px solid #991b1b;
    }

    /* 테이블 레이아웃 */

    .sleep-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 0.8rem;
      margin-top: 10px;
    }

    .sleep-table th,
    .sleep-table td {
      border: 1px solid #e5e7eb;
      padding: 3px;
    }

    .sleep-table thead th {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .sleep-table th.date-col {
      width: 80px;
      min-width: 80px;
    }

    .sleep-cell {
      height: 22px;
      background: #ffffff;
      position: relative;
      cursor: pointer;
    }

    .sleep-cell:hover {
      outline: 1px solid rgba(148, 163, 184, 0.8);
      outline-offset: -1px;
    }

    .sleep-night {
      background: rgba(37, 99, 235, 0.28);  /* 밤 수면 */
    }

    .sleep-awake {
      background: rgba(234, 179, 8, 0.45);   /* 자다 깸 / 깨어있음 */
    }

    .sleep-nap {
      background: rgba(52, 211, 153, 0.45);  /* 낮잠 */
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #dc2626;
      border: 1px solid #991b1b;
      position: absolute;
      right: 2px;
      bottom: 2px;
    }

    .sleep-help {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #666;
    }

    .sleep-data-controls {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.8rem;
    }

    .btn-ghost {
      border: 1px solid #d4d4d8;
      background: #f9fafb;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
    }

    .btn-ghost:hover {
      background: #e5e7eb;
    }

    @media (max-width: 640px) {
      .sleep-table th.date-col {
        position: sticky;
        left: 0;
        z-index: 2;
        background: #f9fafb;
      }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="shell">
      <h1>수면일지 막대그래프 달력</h1>
      <p class="sub">
        · 한 칸 = 1시간, 기준일 정오(12시) ~ 다음날 정오(12시)까지 표시<br/>
        · 밤 수면 / 자다 깸 / 낮잠 / 약 복용 시간을 색으로 기록 (브라우저에 자동 저장)
      </p>
    </div>
  </header>

  <main>
    <div class="shell">
      <section class="section">
        <h2>기록 입력</h2>

        <div class="sleep-controls">
          <div>
            <div class="field-label">기준 날짜</div>
            <input type="date" id="date-input" />
          </div>

          <div>
            <div class="field-label">시작 시간</div>
            <input type="time" id="start-time" />
          </div>

          <div>
            <div class="field-label">끝 시간 (약 복용은 비워도 됨)</div>
            <input type="time" id="end-time" />
          </div>

          <div>
            <div class="field-label">기록 종류</div>
            <div class="sleep-type-group">
              <label><input type="radio" name="segment-type" value="night" checked /> 밤 수면</label>
              <label><input type="radio" name="segment-type" value="awake" /> 깨어있음</label>
              <label><input type="radio" name="segment-type" value="nap" /> 낮잠</label>
              <label><input type="radio" name="segment-type" value="med" /> 약 복용</label>
            </div>
          </div>

          <div>
            <button class="btn primary" id="add-btn" type="button">달력에 추가</button>
          </div>
        </div>

        <div class="sleep-legend">
          <span class="legend-chip">
            <span class="legend-color legend-night"></span> 밤 수면
          </span>
          <span class="legend-chip">
            <span class="legend-color legend-awake"></span> 깨어있음 / 중간에 깸
          </span>
          <span class="legend-chip">
            <span class="legend-color legend-nap"></span> 낮잠
          </span>
          <span class="legend-pill-wrap">
            <span class="legend-pill"></span> 약 복용 시간
          </span>
        </div>

        <p class="sleep-help">
          · 기준 날짜 한 줄이 <b>그날 정오 12시부터 다음날 정오 12시까지</b> 24시간을 의미함.<br/>
          · 예: 2025-11-26 / 23:00~06:00 → 26일 줄의 오른쪽(밤)~다음날 새벽 칸까지 파란색으로 표시.<br/>
          · 입력 후에는 자동으로 이 컴퓨터/브라우저에 저장됨.
        </p>

        <div class="sleep-data-controls">
          <button type="button" class="btn-ghost" id="clear-all-btn">
            전체 데이터 초기화
          </button>
          <button type="button" class="btn-ghost" id="dump-json-btn">
            데이터 JSON 보기 (복사해서 백업용)
          </button>
        </div>

        <textarea id="json-dump" style="margin-top:8px;width:100%;min-height:90px;display:none;font-size:0.75rem;"></textarea>
      </section>

      <section class="section">
        <h2>수면 달력</h2>
        <div class="table-wrap">
          <table class="sleep-table" id="sleep-table">
            <thead>
              <tr id="sleep-header-row">
                <th class="date-col">날짜</th>
              </tr>
            </thead>
            <tbody id="sleep-body">
              <!-- JS에서 날짜별 행 추가 -->
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ===== 상수 & 상태 =====
    const STORAGE_KEY = "sleepLogSegments_v1";

    // segments: {date, kind, start, end} 배열
    let segments = [];

    // 정오 기준 24시간: 12시 ~ 23시, 24시, 1시 ~ 11시
    const SLOT_LABELS = [
      "12시","13시","14시","15시","16시","17시","18시","19시",
      "20시","21시","22시","23시","24시",
      "1시","2시","3시","4시","5시","6시","7시","8시","9시","10시","11시"
    ];

    const headerRow = document.getElementById("sleep-header-row");
    const tbody = document.getElementById("sleep-body");

    const addBtn = document.getElementById("add-btn");
    const clearAllBtn = document.getElementById("clear-all-btn");
    const dumpJsonBtn = document.getElementById("dump-json-btn");
    const jsonDumpArea = document.getElementById("json-dump");

    // ===== 헤더에 시간 슬롯 생성 =====
    SLOT_LABELS.forEach(label => {
      const th = document.createElement("th");
      th.textContent = label;
      headerRow.appendChild(th);
    });

    // ===== 유틸 함수 =====

    // 날짜 표시 형식: 2025-11-26 → 2025.11.26.
    function formatDateLabel(dateStr) {
      if (!dateStr) return "";
      const parts = dateStr.split("-");
      if (parts.length !== 3) return dateStr;
      return parts[0] + "." + parts[1] + "." + parts[2] + ".";
    }

    // 24시간을 "정오 기준" 인덱스로 변환
    // 12:00 → 0, 13:00 → 1, ..., 23:00 → 11, 00:00 → 12, 01:00 → 13, ..., 11:00 → 23
    function timeToSlotIndex(timeStr) {
      if (!timeStr) return null;
      const [hStr, mStr] = timeStr.split(":");
      let h = parseInt(hStr, 10);
      let m = parseInt(mStr || "0", 10);

      if (isNaN(h) || isNaN(m)) return null;

      const t = h + m / 60; // 0~24
      let offset = t - 12;
      if (offset < 0) offset += 24; // 0~24
      const index = Math.floor(offset); // 0~23
      return index;
    }

    // tbody에서 해당 날짜 행 찾기 / 없으면 생성
    function getOrCreateRow(dateStr) {
      let row = tbody.querySelector('tr[data-date="' + dateStr + '"]');
      if (row) return row;

      row = document.createElement("tr");
      row.dataset.date = dateStr;

      const dateCell = document.createElement("td");
      dateCell.textContent = formatDateLabel(dateStr);
      dateCell.classList.add("date-col");
      row.appendChild(dateCell);

      // 24시간 칸
      for (let i = 0; i < 24; i++) {
        const td = document.createElement("td");
        td.classList.add("sleep-cell");
        td.dataset.slotIndex = String(i);
        row.appendChild(td);
      }

      tbody.appendChild(row);
      return row;
    }

    // 셀에 수면 타입 색 입히기
    function applyTypeToCell(cell, type) {
      cell.classList.remove("sleep-night", "sleep-awake", "sleep-nap");
      if (type === "night") cell.classList.add("sleep-night");
      if (type === "awake") cell.classList.add("sleep-awake");
      if (type === "nap") cell.classList.add("sleep-nap");
    }

    // 약 복용 점 찍기 (기존 색 유지)
    function addPillDot(cell) {
      if (cell.querySelector(".pill-dot")) return; // 중복 방지
      const dot = document.createElement("span");
      dot.className = "pill-dot";
      cell.appendChild(dot);
    }

    // 한 segment를 화면에 반영
    function renderSegment(segment) {
      const row = getOrCreateRow(segment.date);
      if (segment.kind === "med") {
        const slotIndex = timeToSlotIndex(segment.start);
        if (slotIndex === null) return;
        const cell = row.querySelector('td[data-slot-index="' + slotIndex + '"]');
        if (cell) addPillDot(cell);
        return;
      }

      if (!segment.start || !segment.end) return;
      fillRange(row, segment.start, segment.end, segment.kind);
    }

    // 구간(시작~끝) 색칠
    function fillRange(row, startTime, endTime, type) {
      const startIndex = timeToSlotIndex(startTime);
      const endIndexRaw = timeToSlotIndex(endTime);

      if (startIndex === null || endIndexRaw === null) return;

      let start = startIndex;
      let end = endIndexRaw;

      // 끝 시간이 시작보다 앞이면 → 다음날로 넘어간 걸로 간주
      if (end <= start) {
        end += 24;
      }

      for (let i = start; i < end; i++) {
        if (i < 0 || i >= 24) continue;
        const slot = i; // 0~23
        const cell = row.querySelector('td[data-slot-index="' + slot + '"]');
        if (!cell) continue;
        applyTypeToCell(cell, type);
      }
    }

    // ===== 저장/로드 =====

    function saveToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(segments));
      } catch (e) {
        console.error("수면일지 저장 실패:", e);
      }
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          segments = [];
          return;
        }
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          segments = parsed;
        } else {
          segments = [];
        }
      } catch (e) {
        console.error("수면일지 로드 실패:", e);
        segments = [];
      }
    }

    function renderAll() {
      // 테이블 내용 초기화
      tbody.innerHTML = "";
      // segment들을 순서대로 다시 그림
      segments.forEach(seg => {
        renderSegment(seg);
      });
    }

    // ===== 이벤트 =====

    addBtn.addEventListener("click", function () {
      const dateStr = document.getElementById("date-input").value;
      const startTime = document.getElementById("start-time").value;
      const endTime = document.getElementById("end-time").value;
      const typeInput = document.querySelector('input[name="segment-type"]:checked');
      const type = typeInput ? typeInput.value : null;

      if (!dateStr) {
        alert("기준 날짜를 입력해 주세요.");
        return;
      }
      if (!startTime) {
        alert("시작 시간을 입력해 주세요.");
        return;
      }
      if (!type) {
        alert("기록 종류를 선택해 주세요.");
        return;
      }

      // segment 생성
      const segment = {
        date: dateStr,
        kind: type,
        start: startTime,
        end: type === "med" ? null : endTime || null
      };

      // '약 복용' 이외는 끝 시간이 필요
      if (segment.kind !== "med" && !segment.end) {
        alert("끝 시간을 입력해 주세요. (약 복용만 끝 시간 생략 가능)");
        return;
      }

      // 상태에 추가하고 저장
      segments.push(segment);
      saveToStorage();

      // 화면에 반영
      renderSegment(segment);
    });

    clearAllBtn.addEventListener("click", function () {
      if (!confirm("수면일지 전체 데이터를 삭제할까요?\n(이 컴퓨터/브라우저에 저장된 기록이 모두 지워집니다.)")) {
        return;
      }
      segments = [];
      saveToStorage();
      tbody.innerHTML = "";
      jsonDumpArea.style.display = "none";
      jsonDumpArea.value = "";
    });

    dumpJsonBtn.addEventListener("click", function () {
      if (jsonDumpArea.style.display === "none") {
        jsonDumpArea.style.display = "block";
        jsonDumpArea.value = JSON.stringify(segments, null, 2);
      } else {
        jsonDumpArea.style.display = "none";
      }
    });

    // ===== 초기 로드 =====
    loadFromStorage();
    renderAll();
  </script>
</body>
</html>
